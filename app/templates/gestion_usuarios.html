{% extends "base.html" %}

{% block title %}
<title>Gestión de Usuarios - Sistema Financiero</title>
{% endblock %}

{% block content %}
<div class="admin-users-page">
    <h2 class="main-title">Gestión de Usuarios y Permisos</h2>
    <p class="main-subtitle">Administra los roles y permisos de los usuarios del sistema</p>
    
    <!-- Guía Rápida -->
    <div class="info-box" style="background: var(--bg-card); border-left: 4px solid var(--secondary); padding: 20px; margin-bottom: 30px; border-radius: 8px; border: 1px solid var(--border-light);">
        <h3 style="margin-top: 0; color: var(--secondary-light);">
            <i class="fa-solid fa-info-circle"></i> ¿Qué puedes hacer aquí?
        </h3>
        <ul style="margin-bottom: 0;">
            {% if es_super_admin %}
            <li><strong>Cambiar roles:</strong> Como Super Administrador, puedes cambiar el rol de cualquier usuario</li>
            <li><strong>Ver permisos:</strong> Cada rol tiene diferentes permisos en el sistema</li>
            <li><strong>Gestión segura:</strong> No puedes cambiar tu propio rol por seguridad</li>
            {% else %}
            <li><strong>Permisos limitados:</strong> Solo el Super Administrador puede cambiar roles de usuarios</li>
            <li><strong>Ver información:</strong> Puedes ver los usuarios y sus roles actuales</li>
            <li><strong>Contacta al SA:</strong> Si necesitas cambiar un rol, contacta al Super Administrador</li>
            {% endif %}
        </ul>
    </div>
    
    <!-- Tabla de Usuarios -->
    <div class="users-table-container">
        <table class="users-table">
            <thead>
                <tr>
                    <th>Nombre</th>
                    <th>Correo</th>
                    <th>Rol Actual</th>
                    <th>Cambiar Rol</th>
                    <th>Acción</th>
                </tr>
            </thead>
            <tbody>
                {% for usuario in usuarios %}
                <tr data-user-id="{{ usuario.id }}">
                    <td>{{ usuario.nombre }}</td>
                    <td>{{ usuario.correo }}</td>
                    <td>
                        <span class="rol-badge rol-{{ usuario.rol_nombre|lower|replace(' ', '-') }}">
                            {{ usuario.rol_nombre }}
                        </span>
                    </td>
                    <td>
                        {% if es_super_admin %}
                        <select class="rol-select" data-user-id="{{ usuario.id }}" data-current-rol="{{ usuario.id_rol }}">
                            {% for rol in roles %}
                            <option value="{{ rol.id }}" {% if rol.id == usuario.id_rol %}selected{% endif %}>
                                {{ rol.nombre }}
                            </option>
                            {% endfor %}
                        </select>
                        {% else %}
                        <span style="color: var(--text-tertiary); font-style: italic;">Solo SA puede cambiar</span>
                        {% endif %}
                    </td>
                    <td>
                        {% if es_super_admin %}
                        <button class="btn-save-rol" data-user-id="{{ usuario.id }}" 
                                {% if usuario.id == current_user.id %}disabled title="No puedes cambiar tu propio rol"{% endif %}>
                            <i class="fa-solid fa-save"></i> Guardar
                        </button>
                        {% else %}
                        <span style="color: var(--text-tertiary); font-size: 0.85rem;">No disponible</span>
                        {% endif %}
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    
    <!-- Mensajes Flash -->
    {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
            <div class="flash-messages" style="margin-top: 20px;">
            {% for category, message in messages %}
                <div class="flash-{{ category }}">{{ message }}</div>
            {% endfor %}
            </div>
        {% endif %}
    {% endwith %}
</div>

<style>
.admin-users-page {
    max-width: 1200px;
    margin: 0 auto;
    padding: 20px;
}

.users-table-container {
    background: var(--bg-card);
    border-radius: 12px;
    box-shadow: var(--shadow-md);
    overflow-x: auto;
    margin-top: 20px;
    -webkit-overflow-scrolling: touch;
}

.users-table {
    width: 100%;
    border-collapse: collapse;
    min-width: 800px;
}

.users-table thead {
    background: linear-gradient(135deg, var(--secondary) 0%, var(--secondary-dark) 100%);
    color: white;
}

.users-table th {
    padding: 15px;
    text-align: left;
    font-weight: 600;
    color: white;
}

.users-table td {
    padding: 15px;
    border-bottom: 1px solid var(--border-light);
    background: var(--bg-card);
    color: var(--text-primary);
}

.users-table tbody tr {
    background: var(--bg-card);
}

.users-table tbody tr:hover {
    background: var(--bg-tertiary);
}

.rol-badge {
    display: inline-block;
    padding: 6px 12px;
    border-radius: 20px;
    font-size: 0.875rem;
    font-weight: 500;
    background: linear-gradient(135deg, var(--secondary) 0%, var(--secondary-dark) 100%);
    color: white;
}

.rol-select {
    padding: 8px 12px;
    border: 1px solid var(--border-medium);
    border-radius: 6px;
    font-size: 0.9rem;
    background: var(--bg-tertiary);
    color: var(--text-primary);
    cursor: pointer;
    min-width: 150px;
}

.rol-select:focus {
    outline: none;
    border-color: var(--secondary);
    box-shadow: 0 0 0 3px rgba(74, 158, 255, 0.2);
}

.rol-select option {
    background: var(--bg-card);
    color: var(--text-primary);
}

.btn-save-rol {
    padding: 8px 16px;
    background: linear-gradient(135deg, var(--secondary) 0%, var(--secondary-dark) 100%);
    color: white;
    border: none;
    border-radius: 6px;
    cursor: pointer;
    font-size: 0.9rem;
    transition: all 0.2s;
    font-weight: 500;
}

.btn-save-rol:hover:not(:disabled) {
    background: linear-gradient(135deg, var(--secondary-dark) 0%, var(--secondary) 100%);
    transform: translateY(-1px);
    box-shadow: 0 4px 12px rgba(74, 158, 255, 0.4);
}

.btn-save-rol:disabled {
    background: var(--bg-tertiary);
    color: var(--text-tertiary);
    cursor: not-allowed;
    opacity: 0.6;
}

.info-box ul {
    list-style: none;
    padding-left: 0;
}

.info-box li {
    padding: 8px 0;
    padding-left: 24px;
    position: relative;
    color: var(--text-primary);
}

.info-box li:before {
    content: "✓";
    position: absolute;
    left: 0;
    color: var(--success);
    font-weight: bold;
}

/* Responsive para móviles */
@media (max-width: 768px) {
    .users-table-container {
        margin: 0 -16px;
        border-radius: 0;
    }
    
    .users-table {
        font-size: 0.85em;
    }
    
    .users-table th,
    .users-table td {
        padding: 10px 8px;
        font-size: 0.9em;
    }
    
    .rol-select {
        min-width: 120px;
        font-size: 0.85em;
    }
    
    .btn-save-rol {
        padding: 6px 12px;
        font-size: 0.85em;
    }
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const saveButtons = document.querySelectorAll('.btn-save-rol');
    
    saveButtons.forEach(button => {
        button.addEventListener('click', function() {
            const userId = this.getAttribute('data-user-id');
            const row = this.closest('tr');
            const select = row.querySelector('.rol-select');
            const nuevoRolId = select.value;
            const currentRolId = select.getAttribute('data-current-rol');
            
            if (nuevoRolId === currentRolId) {
                alert('El usuario ya tiene este rol asignado.');
                return;
            }
            
            if (!confirm('¿Estás seguro de cambiar el rol de este usuario?')) {
                return;
            }
            
            // Deshabilitar botón mientras se procesa
            this.disabled = true;
            this.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> Guardando...';
            
            fetch('{{ url_for("admin.cambiar_rol_usuario") }}', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    usuario_id: parseInt(userId),
                    nuevo_rol_id: parseInt(nuevoRolId)
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert(data.message);
                    // Actualizar el badge del rol
                    const rolNombre = select.options[select.selectedIndex].text;
                    const badge = row.querySelector('.rol-badge');
                    badge.textContent = rolNombre;
                    badge.className = 'rol-badge rol-' + rolNombre.toLowerCase().replace(/\s+/g, '-');
                    // Actualizar el rol actual
                    select.setAttribute('data-current-rol', nuevoRolId);
                    // Recargar la página para reflejar cambios
                    setTimeout(() => location.reload(), 1000);
                } else {
                    alert('Error: ' + data.message);
                    this.disabled = false;
                    this.innerHTML = '<i class="fa-solid fa-save"></i> Guardar';
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Error al cambiar el rol. Por favor, intenta de nuevo.');
                this.disabled = false;
                this.innerHTML = '<i class="fa-solid fa-save"></i> Guardar';
            });
        });
    });
});
</script>
{% endblock %}

