{% extends "base.html" %}

{% block title %}
<title>Estado de Resultados Proforma - Sistema Financiero</title>
{% endblock %}

{% block content %}

<div class="container-fluid my-4">
    <div class="row mb-4">
        <div class="col-12">
            <h2 class="main-title mb-3">Estado de Resultados Proforma</h2>
            <p class="main-subtitle mb-4">Proyección financiera basada en el método de porcentaje de ventas.</p>

            <div class="card shadow-sm mb-4">
                <div class="card-body">
                    <form method="GET" action="{{ url_for('analysis.proforma') }}">
                        <div class="row g-3 align-items-end">
                            <div class="col-md-4">
                                <label for="anio_base" class="form-label fw-bold">Año Base:</label>
                                <select name="anio_base" id="anio_base" class="form-select" required>
                                    <option value="">-- Selecciona --</option>
                                    {% for anio in periodos %}
                                    <option value="{{ anio }}" {% if anio==anio_base %}selected{% endif %}>
                                        Año {{ anio }}
                                    </option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="col-md-4">
                                <label for="tasa_crecimiento" class="form-label fw-bold">Tasa de Crecimiento
                                    (%):</label>
                                <div class="input-group">
                                    <input type="number" step="0.01" name="tasa_crecimiento" id="tasa_crecimiento"
                                        class="form-control" placeholder="Ej. 15"
                                        value="{{ tasa_crecimiento if tasa_crecimiento is not none else '' }}" required>
                                    <span class="input-group-text">%</span>
                                </div>
                                <small class="text-muted">Ejemplo: 15 para un crecimiento del 15%</small>
                            </div>
                            <div class="col-md-4">
                                <button type="submit" class="btn btn-primary w-100">
                                    <i class="fa-solid fa-chart-line me-2"></i> Generar Proyección
                                </button>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    {% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
    {% for category, message in messages %}
    <div class="alert alert-{{ 'danger' if category == 'error' else ('success' if category == 'success' else 'warning') }} alert-dismissible fade show"
        role="alert">
        <i
            class="fa-solid fa-{% if category == 'error' %}exclamation-circle{% elif category == 'success' %}check-circle{% else %}info-circle{% endif %} me-2"></i>
        {{ message }}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    </div>
    {% endfor %}
    {% endif %}
    {% endwith %}

    {% if proforma_data %}
    <div class="card shadow-lg mb-4">
        <div class="card-header bg-primary text-white">
            <h3 class="mb-0">
                <i class="fa-solid fa-table me-2"></i>
                {{ proforma_data.escenario }}
            </h3>
        </div>
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-hover table-bordered align-middle">
                    <thead class="table-light text-center">
                        <tr>
                            <th>Concepto</th>
                            <th>Año Base ({{ anio_base }})</th>
                            <th>Proyectado</th>
                            <th>Variación (C$)</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% set items = [
                        ('Ingresos por Ventas', 'ingresos'),
                        ('(-) Costo de Ventas', 'costos'),
                        ('(=) Utilidad Bruta', 'utilidad_bruta'),
                        ('(-) Gastos Operativos', 'gastos_operativos'),
                        ('(=) Utilidad Antes de Impuestos', 'utilidad_antes_impuestos'),
                        ('(-) Impuestos', 'impuestos'),
                        ('(=) Utilidad Neta', 'utilidad_neta')
                        ] %}

                        {% for label, key in items %}
                        {% set row = proforma_data.datos[key] %}
                        <tr class="{% if 'Utilidad' in label %}table-active fw-bold{% endif %}">
                            <td>{{ label }}</td>
                            <td class="text-end">C$ {{ "%.2f"|format(row.base) }}</td>
                            <td class="text-end fw-bold text-primary">C$ {{ "%.2f"|format(row.proyectado) }}</td>
                            <td class="text-end {% if row.variacion < 0 %}text-danger{% else %}text-success{% endif %}">
                                {{ "+" if row.variacion > 0 else "" }}{{ "%.2f"|format(row.variacion) }}
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>

            <div class="alert alert-info mt-3">
                <i class="fa-solid fa-lightbulb me-2"></i>
                <strong>Nota Metodológica:</strong> Esta proyección asume que los costos y gastos operativos mantienen
                su proporción histórica respecto a las ventas (Comportamiento Variable). Los impuestos se recalculan
                aplicando la tasa impositiva efectiva del año base.
            </div>
        </div>
    </div>
    {% endif %}

</div>

{% endblock %}