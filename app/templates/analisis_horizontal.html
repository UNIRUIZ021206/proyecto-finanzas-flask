{% extends "base.html" %}

{% block title %}
<title>Análisis Horizontal - Sistema Financiero</title>
{% endblock %}

{% block content %}

<div class="container-fluid my-4">
    <div class="row mb-4">
        <div class="col-12">
            <h2 class="main-title mb-3">Análisis Horizontal</h2>
            <p class="main-subtitle mb-4">Comparación de estados financieros entre dos períodos (Valor Absoluto
                y Valor
                Relativo %).</p>

            <div class="card shadow-sm mb-4">
                <div class="card-body">
                    <form method="GET" action="{{ url_for('analysis.analisis_horizontal') }}">
                        <div class="row g-3 align-items-end">
                            <div class="col-md-4">
                                <label for="periodo_base" class="form-label fw-bold">Período Base:</label>
                                <select name="periodo_base" id="periodo_base" class="form-select">
                                    <option value="">-- Selecciona --</option>
                                    {% for anio in periodos %}
                                    <option value="{{ anio }}" {% if anio==periodo_base %}selected{% endif %}>
                                        Año {{ anio }}
                                    </option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="col-md-4">
                                <label for="periodo_analisis" class="form-label fw-bold">Período de
                                    Análisis:</label>
                                <select name="periodo_analisis" id="periodo_analisis" class="form-select">
                                    <option value="">-- Selecciona --</option>
                                    {% for anio in periodos %}
                                    <option value="{{ anio }}" {% if anio==periodo_analisis %}selected{% endif %}>
                                        Año {{ anio }}
                                    </option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="col-md-4">
                                <button type="submit" class="btn btn-primary w-100">
                                    <i class="fa-solid fa-chart-line me-2"></i> Analizar
                                </button>
                            </div>
                        </div>
                        <small class="text-muted d-block mt-2">
                            <i class="fa-solid fa-info-circle me-1"></i> El período base debe ser menor que el
                            período
                            de análisis.
                        </small>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Filtro de Cuentas -->
    {% if analisis_comparativo %}
    <div class="card shadow-sm mb-4">
        <div class="card-body">
            <div class="row g-3 align-items-end">
                <div class="col-md-12">
                    <label for="account-filter" class="form-label fw-bold">
                        <i class="fa-solid fa-filter me-2"></i> Filtrar Cuentas:
                    </label>
                    <select id="account-filter" class="form-select">
                        <option value="all">Mostrar Todo</option>
                        <!-- Opciones se llenarán dinámicamente con JS -->
                    </select>
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    {% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
    {% for category, message in messages %}
    <div class="alert alert-{{ 'danger' if category == 'error' else ('success' if category == 'success' else 'warning') }} alert-dismissible fade show"
        role="alert">
        <i
            class="fa-solid fa-{% if category == 'error' %}exclamation-circle{% elif category == 'success' %}check-circle{% else %}info-circle{% endif %} me-2"></i>
        {{ message }}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    </div>
    {% endfor %}
    {% endif %}
    {% endwith %}

    {% if analisis_comparativo %}
    <div class="mb-4">
        <a href="{{ url_for('analysis.exportar_excel') }}?periodo_base={{ periodo_base }}&periodo_analisis={{ periodo_analisis }}&tipo=horizontal"
            class="btn btn-success btn-lg w-100"
            style="background: linear-gradient(135deg, #28a745 0%, #218838 100%); border: none; box-shadow: 0 4px 16px rgba(40, 167, 69, 0.4);">
            <i class="fa-solid fa-file-excel me-2"></i> Exportar Análisis a Excel
        </a>
    </div>

    <!-- Contenedor para Análisis IA -->
    <div id="ai-analysis-container" class="mb-5">
        <div class="card border-0 shadow-lg"
            style="background: rgba(30, 41, 59, 0.6); backdrop-filter: blur(20px); border-radius: 16px; border: 1px solid rgba(255,255,255,0.08);">
            <div class="card-body text-center py-5">
                <div class="spinner-border text-primary mb-3" role="status" style="width: 3rem; height: 3rem;">
                    <span class="visually-hidden">Cargando...</span>
                </div>
                <h5 class="text-white">Generando análisis financiero inteligente con Gemini AI...</h5>
                <p class="text-muted small">Esto puede tomar unos segundos.</p>
            </div>
        </div>
    </div>

    <div class="card shadow-lg mb-5">
        <div class="card-header bg-primary text-white">
            <h3 class="mb-0">
                <i class="fa-solid fa-balance-scale me-2"></i>
                Balance General - Comparación Período Base ({{ periodo_base }}) vs Período Análisis ({{
                periodo_analisis
                }})
            </h3>
        </div>
        <div class="card-body p-0">
            <div class="table-responsive">
                <table class="table table-bordered border-primary mb-0 table-hover">
                    <thead class="table-primary">
                        <tr>
                            <th style="width: 30%;">Cuenta</th>
                            <th class="text-end">Período Base ({{ periodo_base }})</th>
                            <th class="text-end">Período Análisis ({{ periodo_analisis }})</th>
                            <th class="text-end">Valor Absoluto</th>
                            <th class="text-end">Valor Relativo %</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% if 'Activo' in analisis_comparativo %}
                        {% for subtipo, cuentas in analisis_comparativo.Activo.items() %}
                        <tr class="table-info" data-main-type="Activo" data-subtype="{{ subtipo }}">
                            <td colspan="5" class="fw-bold">{{ subtipo }}</td>
                        </tr>
                        {% for cuenta in cuentas %}
                        <tr data-main-type="Activo" data-subtype="{{ subtipo }}">
                            <td class="ps-4">{{ cuenta.nombre }}</td>
                            <td class="text-end">{{ "%.2f"|format(cuenta.monto_base) }}</td>
                            <td class="text-end">{{ "%.2f"|format(cuenta.monto_analisis) }}</td>
                            <td class="text-end">
                                <span class="{{ cuenta.color_clase }}">{{ "%.2f"|format(cuenta.absoluto)
                                    }}</span>
                            </td>
                            <td class="text-end">
                                <span class="{{ cuenta.color_clase }}">
                                    {% if cuenta.relativo | is_inf %}∞{% else %}{{
                                    "%.2f"|format(cuenta.relativo) }}%{%
                                    endif %}
                                </span>
                            </td>
                        </tr>
                        {% endfor %}
                        {% endfor %}
                        {% endif %}

                        {% if 'Pasivo' in analisis_comparativo %}
                        {% for subtipo, cuentas in analisis_comparativo.Pasivo.items() %}
                        <tr class="table-info" data-main-type="Pasivo" data-subtype="{{ subtipo }}">
                            <td colspan="5" class="fw-bold">{{ subtipo }}</td>
                        </tr>
                        {% for cuenta in cuentas %}
                        <tr data-main-type="Pasivo" data-subtype="{{ subtipo }}">
                            <td class="ps-4">{{ cuenta.nombre }}</td>
                            <td class="text-end">{{ "%.2f"|format(cuenta.monto_base) }}</td>
                            <td class="text-end">{{ "%.2f"|format(cuenta.monto_analisis) }}</td>
                            <td class="text-end">
                                <span class="{{ cuenta.color_clase }}">{{ "%.2f"|format(cuenta.absoluto)
                                    }}</span>
                            </td>
                            <td class="text-end">
                                <span class="{{ cuenta.color_clase }}">
                                    {% if cuenta.relativo | is_inf %}∞{% else %}{{
                                    "%.2f"|format(cuenta.relativo) }}%{%
                                    endif %}
                                </span>
                            </td>
                        </tr>
                        {% endfor %}
                        {% endfor %}
                        {% endif %}

                        {% if 'Patrimonio' in analisis_comparativo %}
                        {% for subtipo, cuentas in analisis_comparativo.Patrimonio.items() %}
                        <tr class="table-info" data-main-type="Patrimonio" data-subtype="{{ subtipo }}">
                            <td colspan="5" class="fw-bold">{{ subtipo }}</td>
                        </tr>
                        {% for cuenta in cuentas %}
                        <tr data-main-type="Patrimonio" data-subtype="{{ subtipo }}">
                            <td class="ps-4">{{ cuenta.nombre }}</td>
                            <td class="text-end">{{ "%.2f"|format(cuenta.monto_base) }}</td>
                            <td class="text-end">{{ "%.2f"|format(cuenta.monto_analisis) }}</td>
                            <td class="text-end">
                                <span class="{{ cuenta.color_clase }}">{{ "%.2f"|format(cuenta.absoluto)
                                    }}</span>
                            </td>
                            <td class="text-end">
                                <span class="{{ cuenta.color_clase }}">
                                    {% if cuenta.relativo | is_inf %}∞{% else %}{{
                                    "%.2f"|format(cuenta.relativo) }}%{%
                                    endif %}
                                </span>
                            </td>
                        </tr>
                        {% endfor %}
                        {% endfor %}
                        {% endif %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <div class="card shadow-lg mb-5">
        <div class="card-header bg-success text-white">
            <h3 class="mb-0">
                <i class="fa-solid fa-chart-line me-2"></i>
                Estado de Resultados - Comparación Período Base ({{ periodo_base }}) vs Período Análisis ({{
                periodo_analisis }})
            </h3>
        </div>
        <div class="card-body p-0">
            <div class="table-responsive">
                <table class="table table-bordered border-success mb-0 table-hover">
                    <thead class="table-success">
                        <tr>
                            <th style="width: 30%;">Cuenta</th>
                            <th class="text-end">Período Base ({{ periodo_base }})</th>
                            <th class="text-end">Período Análisis ({{ periodo_analisis }})</th>
                            <th class="text-end">Valor Absoluto</th>
                            <th class="text-end">Valor Relativo %</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% if 'Ingreso' in analisis_comparativo %}
                        {% for subtipo, cuentas in analisis_comparativo.Ingreso.items() %}
                        <tr class="table-info" data-main-type="Ingreso" data-subtype="{{ subtipo }}">
                            <td colspan="5" class="fw-bold">{{ subtipo }}</td>
                        </tr>
                        {% for cuenta in cuentas %}
                        <tr data-main-type="Ingreso" data-subtype="{{ subtipo }}">
                            <td class="ps-4">{{ cuenta.nombre }}</td>
                            <td class="text-end">{{ "%.2f"|format(cuenta.monto_base) }}</td>
                            <td class="text-end">{{ "%.2f"|format(cuenta.monto_analisis) }}</td>
                            <td class="text-end">
                                <span class="{{ cuenta.color_clase }}">{{ "%.2f"|format(cuenta.absoluto)
                                    }}</span>
                            </td>
                            <td class="text-end">
                                <span class="{{ cuenta.color_clase }}">
                                    {% if cuenta.relativo | is_inf %}∞{% else %}{{
                                    "%.2f"|format(cuenta.relativo) }}%{%
                                    endif %}
                                </span>
                            </td>
                        </tr>
                        {% endfor %}
                        {% endfor %}
                        <tr class="table-success">
                            <td class="fw-bold">TOTAL INGRESOS</td>
                            <td class="text-end fw-bold">{{
                                "%.2f"|format(analisis_comparativo.Totales.get('Ingreso',
                                {}).get('base', 0.0)) }}</td>
                            <td class="text-end fw-bold">{{
                                "%.2f"|format(analisis_comparativo.Totales.get('Ingreso',
                                {}).get('analisis', 0.0)) }}</td>
                            <td class="text-end fw-bold">
                                <span
                                    class="{{ analisis_comparativo.Totales.get('Ingreso', {}).get('color_clase', '') }}">
                                    {{ "%.2f"|format(analisis_comparativo.Totales.get('Ingreso',
                                    {}).get('absoluto',
                                    0.0)) }}
                                </span>
                            </td>
                            <td class="text-end fw-bold">
                                <span
                                    class="{{ analisis_comparativo.Totales.get('Ingreso', {}).get('color_clase', '') }}">
                                    {% set total_ingreso = analisis_comparativo.Totales.get('Ingreso', {}) %}
                                    {% if total_ingreso.get('relativo', 0) | is_inf %}∞{% else %}{{
                                    "%.2f"|format(total_ingreso.get('relativo', 0.0)) }}%{% endif %}
                                </span>
                            </td>
                        </tr>
                        {% endif %}

                        {% if 'Costo' in analisis_comparativo %}
                        {% for subtipo, cuentas in analisis_comparativo.Costo.items() %}
                        <tr class="table-info" data-main-type="Costo" data-subtype="{{ subtipo }}">
                            <td colspan="5" class="fw-bold">{{ subtipo }}</td>
                        </tr>
                        {% for cuenta in cuentas %}
                        <tr data-main-type="Costo" data-subtype="{{ subtipo }}">
                            <td class="ps-4">{{ cuenta.nombre }}</td>
                            <td class="text-end">{{ "%.2f"|format(cuenta.monto_base) }}</td>
                            <td class="text-end">{{ "%.2f"|format(cuenta.monto_analisis) }}</td>
                            <td class="text-end">
                                <span class="{{ cuenta.color_clase }}">{{ "%.2f"|format(cuenta.absoluto)
                                    }}</span>
                            </td>
                            <td class="text-end">
                                <span class="{{ cuenta.color_clase }}">
                                    {% if cuenta.relativo | is_inf %}∞{% else %}{{
                                    "%.2f"|format(cuenta.relativo) }}%{%
                                    endif %}
                                </span>
                            </td>
                        </tr>
                        {% endfor %}
                        {% endfor %}
                        <tr class="table-danger">
                            <td class="fw-bold">TOTAL COSTOS</td>
                            <td class="text-end fw-bold">{{
                                "%.2f"|format(analisis_comparativo.Totales.get('Costo',
                                {}).get('base', 0.0)) }}</td>
                            <td class="text-end fw-bold">{{
                                "%.2f"|format(analisis_comparativo.Totales.get('Costo',
                                {}).get('analisis', 0.0)) }}</td>
                            <td class="text-end fw-bold">
                                <span
                                    class="{{ analisis_comparativo.Totales.get('Costo', {}).get('color_clase', '') }}">
                                    {{ "%.2f"|format(analisis_comparativo.Totales.get('Costo',
                                    {}).get('absoluto', 0.0))
                                    }}
                                </span>
                            </td>
                            <td class="text-end fw-bold">
                                <span
                                    class="{{ analisis_comparativo.Totales.get('Costo', {}).get('color_clase', '') }}">
                                    {% set total_costo = analisis_comparativo.Totales.get('Costo', {}) %}
                                    {% if total_costo.get('relativo', 0) | is_inf %}∞{% else %}{{
                                    "%.2f"|format(total_costo.get('relativo', 0.0)) }}%{% endif %}
                                </span>
                            </td>
                        </tr>
                        {% endif %}

                        {% if 'Gasto' in analisis_comparativo %}
                        {% for subtipo, cuentas in analisis_comparativo.Gasto.items() %}
                        <tr class="table-info" data-main-type="Gasto" data-subtype="{{ subtipo }}">
                            <td colspan="5" class="fw-bold">{{ subtipo }}</td>
                        </tr>
                        {% for cuenta in cuentas %}
                        <tr data-main-type="Gasto" data-subtype="{{ subtipo }}">
                            <td class="ps-4">{{ cuenta.nombre }}</td>
                            <td class="text-end">{{ "%.2f"|format(cuenta.monto_base) }}</td>
                            <td class="text-end">{{ "%.2f"|format(cuenta.monto_analisis) }}</td>
                            <td class="text-end">
                                <span class="{{ cuenta.color_clase }}">{{ "%.2f"|format(cuenta.absoluto)
                                    }}</span>
                            </td>
                            <td class="text-end">
                                <span class="{{ cuenta.color_clase }}">
                                    {% if cuenta.relativo | is_inf %}∞{% else %}{{
                                    "%.2f"|format(cuenta.relativo) }}%{%
                                    endif %}
                                </span>
                            </td>
                        </tr>
                        {% endfor %}
                        {% endfor %}
                        <tr class="table-danger">
                            <td class="fw-bold">TOTAL GASTOS</td>
                            <td class="text-end fw-bold">{{
                                "%.2f"|format(analisis_comparativo.Totales.get('Gasto',
                                {}).get('base', 0.0)) }}</td>
                            <td class="text-end fw-bold">{{
                                "%.2f"|format(analisis_comparativo.Totales.get('Gasto',
                                {}).get('analisis', 0.0)) }}</td>
                            <td class="text-end fw-bold">
                                <span
                                    class="{{ analisis_comparativo.Totales.get('Gasto', {}).get('color_clase', '') }}">
                                    {{ "%.2f"|format(analisis_comparativo.Totales.get('Gasto',
                                    {}).get('absoluto', 0.0))
                                    }}
                                </span>
                            </td>
                            <td class="text-end fw-bold">
                                <span
                                    class="{{ analisis_comparativo.Totales.get('Gasto', {}).get('color_clase', '') }}">
                                    {% set total_gasto = analisis_comparativo.Totales.get('Gasto', {}) %}
                                    {% if total_gasto.get('relativo', 0) | is_inf %}∞{% else %}{{
                                    "%.2f"|format(total_gasto.get('relativo', 0.0)) }}%{% endif %}
                                </span>
                            </td>
                        </tr>
                        {% endif %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    {% else %}
    <div class="alert alert-info" role="alert">
        <i class="fa-solid fa-info-circle me-2"></i>
        No hay datos comparativos disponibles. Por favor, selecciona dos períodos diferentes.
    </div>
    {% endif %}
</div>

<style>
    /* Estilos para el Análisis de IA */
    .ai-content {
        color: #1e293b !important;
    }

    .ai-content * {
        color: #1e293b !important;
    }

    .ai-content strong,
    .ai-content b {
        color: #0f172a !important;
        font-weight: 700;
    }
</style>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        const aiContainer = document.getElementById('ai-analysis-container');
        // Solo ejecutar si existe el contenedor (lo que implica que hay datos comparativos)
        if (aiContainer) {
            const periodoBase = "{{ periodo_base }}";
            const periodoAnalisis = "{{ periodo_analisis }}";

            if (periodoBase && periodoAnalisis) {
                fetch(`{{ url_for('analysis.api_horizontal_ia') }}?base=${periodoBase}&analisis=${periodoAnalisis}`)
                    .then(response => response.json())
                    .then(data => {
                        if (data.html) {
                            aiContainer.innerHTML = `
                                <div class="card border-0 shadow-lg" style="background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(20px); border-radius: 16px; border: 1px solid rgba(0,0,0,0.1);">
                                    <div class="card-header border-0 p-4" style="background: linear-gradient(90deg, #6366f1 0%, #4f46e5 100%); border-radius: 16px 16px 0 0;">
                                        <h4 class="mb-0 text-white"><i class="fa-solid fa-robot me-2"></i>Análisis Inteligente (IA)</h4>
                                    </div>
                                    <div class="card-body p-4">
                                        <div class="ai-content text-dark" style="font-size: 1.05rem; line-height: 1.7; color: #1e293b;">
                                            ${data.html}
                                        </div>
                                    </div>
                                </div>
                            `;
                        } else {
                            aiContainer.innerHTML = `
                                <div class="alert alert-warning border-0 shadow-sm rounded-3">
                                    <i class="fa-solid fa-exclamation-triangle me-2"></i>
                                    No se pudo generar el análisis por IA en este momento.
                                    ${data.error ? '<br><small>' + data.error + '</small>' : ''}
                                </div>
                            `;
                        }
                    })
                    .catch(error => {
                        console.error('Error fetching AI analysis:', error);
                        aiContainer.innerHTML = `
                            <div class="alert alert-danger border-0 shadow-sm rounded-3">
                                <i class="fa-solid fa-circle-xmark me-2"></i>
                                Error al conectar con el servicio de IA.
                            </div>
                        `;
                    });
            }
        }
    });

    // Script para el filtro de cuentas por subtipos
    document.addEventListener('DOMContentLoaded', function () {
        const filterSelect = document.getElementById('account-filter');
        if (!filterSelect) return;

        // Recolectar todos los subtipos únicos
        const rows = document.querySelectorAll('tr[data-subtype]');
        const subtypes = new Set();

        rows.forEach(row => {
            const subtype = row.getAttribute('data-subtype');
            if (subtype) subtypes.add(subtype);
        });

        // Agregar opciones de subtipos
        if (subtypes.size > 0) {
            Array.from(subtypes).sort().forEach(subtype => {
                const option = document.createElement('option');
                option.value = subtype;
                option.textContent = subtype;
                filterSelect.appendChild(option);
            });
        }

        // Manejar evento de cambio
        filterSelect.addEventListener('change', function () {
            const value = this.value;
            const allRows = document.querySelectorAll('tr[data-subtype]');
            const cards = document.querySelectorAll('.card.shadow-lg');

            if (value === 'all') {
                // Mostrar todo
                allRows.forEach(row => row.classList.remove('hidden-row'));
                cards.forEach(card => card.classList.remove('hidden-section'));
            } else {
                // Ocultar todo primero
                allRows.forEach(row => row.classList.add('hidden-row'));

                // Mostrar solo las filas que coinciden con el subtipo seleccionado
                document.querySelectorAll(`tr[data-subtype="${value}"]`).forEach(row => {
                    row.classList.remove('hidden-row');
                });

                // Ocultar cards vacíos
                cards.forEach(card => {
                    const visibleRows = card.querySelectorAll('tr:not(.hidden-row)');
                    if (visibleRows.length === 0) {
                        card.classList.add('hidden-section');
                    } else {
                        card.classList.remove('hidden-section');
                    }
                });
            }
        });
    });
</script>

{% endblock %}